// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS

enum GameStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

enum AgentType {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

enum BuiltInAgentType {
  RANDOM
  THRESHOLD
  MOVING_AVERAGE
  ADAPTIVE
}

// MODELS

model Game {
  id String @id @default(uuid())
  name String
  description String?

  // config
  totalRounds Int @map("total_rounds")
  capacityPercent Float? @map("capacity_percent")
  totalAgents Int @map("total_agents")

  //benefit
  benefitRules Json @map("benefit_rules")

  // State
  status GameStatus @default(DRAFT)
  currentRound Int @default(0) @map("current_round")
  seed String?

  //Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  startedAt DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at") 

  //Relations
  agents GameAgent[]
  rounds Round[]

  @@map("games")
}

model Agent {
  id String @id @default(uuid())
  name String
  type AgentType
  builtInType BuiltInAgentType? @map("built_in_type")

  // custom agent
  customCode String? @map("custom_code") @db.Text

  // Configuration
  config Json?

  //Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String? @map("created_by") //tg user id

  games GameAgent[]
  @@map("agents")
}

model GameAgent {
  id String @id @default(uuid())
  gameId String @map("game_id")
  agentId String @map("agent_id")

  totalScore Float @default(0) @map("total_score")
  attendanceCount Int @default(0) @map("attendance_count")
  winCount Int @default(0) @map("win_count")

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  decisions Decision[]
  
  @@unique([gameId, agentId])
  @@map("game_agents")
}

model Round {
  id              String      @id @default(uuid())
  gameId          String      @map("game_id")
  roundNumber     Int         @map("round_number")
  
  // Results
  attendance      Int
  capacity        Int
  wasOvercrowded  Boolean     @map("was_overcrowded")
  attendeeBenefit Float       @map("attendee_benefit")
  stayerBenefit   Float       @map("stayer_benefit")
  
  //when
  executedAt      DateTime    @default(now()) @map("executed_at")
  
  game            Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  decisions       Decision[]
  
  @@unique([gameId, roundNumber])
  @@map("rounds")  
}

model Decision {
  id          String    @id @default(uuid())
  roundId     String    @map("round_id")
  gameAgentId String    @map("game_agent_id")
  
  // Decision data
  wentToBar   Boolean   @map("went_to_bar")
  prediction  Int?    // Agent's predicted attendance (0-Max capacity)
  confidence  Float?    // Agent's confidence in prediction
  benefit     Float     @default(0)
  
  // Relations
  round       Round     @relation(fields: [roundId], references: [id], onDelete: Cascade)
  gameAgent   GameAgent @relation(fields: [gameAgentId], references: [id], onDelete: Cascade)
  
  @@unique([roundId, gameAgentId])
  @@map("decisions")
}

model TelegramUser {
  id            String    @id // Telegram user ID as string
  username      String?
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  
  // Stats
  gamesPlayed   Int       @default(0) @map("games_played")
  totalScore    Float     @default(0) @map("total_score")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  lastActiveAt  DateTime  @default(now()) @map("last_active_at")
  
  @@map("telegram_users")
}